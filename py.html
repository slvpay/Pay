<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout with PayPal</title>
  <style>
    body {
      padding: 20px;
      display: none;
    }
    h1 {
      text-align: center;
    }
  </style>
  <script>
    const PAYPAL_SCRIPT_URL = "https://www.paypal.com/sdk/js";

    async function getPaymentData() {
      const params = new URLSearchParams(window.location.search);
      const ref = params.get("ref");

      if (!ref) {
        alert("Missing reference.");
        return null;
      }

      try {
        // Fetch only non-sensitive data from backend
        const res = await fetch(`https://apps-init-paypal.alexskeioslav.workers.dev/get-minimal?ref=${ref}`);
        if (!res.ok) {
          alert("❌ Payment expired.");
          return null;
        }
        const data = await res.json();

        // Validate minimal fields needed for this page
        if (!data.Client_Id || !data.Plan_Name || !data.Plan_Cost) {
          alert("❌ Payment expired");
          return null;
        }

        // Include Country_Code with fallback
        const Country_Code = data.Country_Code && data.Country_Code.trim() !== "" ? data.Country_Code : "US";

        return { 
          ref, 
          Client_Id: data.Client_Id, 
          Plan_Name: data.Plan_Name, 
          Plan_Cost: data.Plan_Cost,
          Country_Code
        };
      } catch (err) {
        console.error("Error fetching payment data:", err);
        alert("❌ Error loading payment info.");
        return null;
      }
    }

    let paymentData = null;

    document.addEventListener("DOMContentLoaded", async () => {
      paymentData = await getPaymentData();
      if (!paymentData) return;

      document.body.style.display = "block";
      document.getElementById("plan-name").textContent = paymentData.Plan_Name;
      document.getElementById("cost").textContent = paymentData.Plan_Cost;

      const script = document.createElement("script");
      script.src = `${PAYPAL_SCRIPT_URL}?client-id=${paymentData.Client_Id}`;
      script.onload = loadPayPalButtons;
      document.body.appendChild(script);
    });

    function loadPayPalButtons() {
      paypal.Buttons({
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: paymentData.Plan_Cost,
                currency_code: "USD"
              }
            }],
            payer: {
          address: {
            country_code: paymentData.Country_Code
          }
        },
        application_context: {
              shipping_preference: "NO_SHIPPING"
            }
          });
        },
        onApprove: async (data, actions) => {
          const details = await actions.order.capture();
          // Get capture ID
          const captureId = details.purchase_units?.[0]?.payments?.captures?.[0]?.id;

          if (!captureId) {
            alert("❌ Payment captured, but an error occurred");
          }
          // Send Capture ID if available, otherwise fallback to Order ID
          const transactionId = captureId || details.id;

          // Send only ref and transactionId to your new worker
          fetch("https://paypal-payment-handler.alexskeioslav.workers.dev/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              ref: paymentData.ref,
              transactionId: transactionId
            })
          })
          .then(() => {
  document.getElementById("paypal-button-container").innerHTML = 
    "<p style='text-align:center; color:green;'>✅ Payment successful! You can now return to the app.</p>";
})

          .catch(() => {
            alert("❌ Failed to send payment confirmation.");
          });
        }
      }).render("#paypal-button-container");
    }
  </script>
</head>
<body>
  <h1>Complete Checkout</h1>
  <p style="text-align: center;">
    Plan: <strong><span id="plan-name"></span></strong> -
    Cost: <strong>$<span id="cost"></span></strong>
  </p>
  <div id="paypal-button-container"></div>
</body>
</html>
